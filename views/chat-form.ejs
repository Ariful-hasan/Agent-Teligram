<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
    .cursor{cursor: pointer;}
</style>

<%= JSON.stringify(data.onlineusers) %>

<div class="row">

        <% if (data.type == "A") { %>
            <div class="col-md-2">
                <div class="card card-info">
                    <div class="card-header text-center">Online Users</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12" id="logged_users">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>


        <div class=" <%= data.type == 'U'? 'offset-md-2' : '' %> col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                            <div class="col-md-6"><%= data.name%></div>
                            <div class="col-md-6"><a class="float-right" href="/logout">Log Out</a></div>
                    </div>
                </div>
                <div class="card-body">

                    <% if (data.userid) { %>
                    <!-- <div class="alert alert-info alert-dismissible fade show invisible" role="alert" id="alert">
                        <strong id="connection_msg"></strong>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                    </div> -->

                    <div class="col-md-12 invisible">
                        <div class="card">
                            <div class="card-body">
                                <ul id="msg_list"></ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-12 mb-0">
                        <form action="" method="POST">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" placeholder="message" aria-label="message"
                                    id="message" aria-describedby="basic-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-info" type="button" id="send">Send</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <% } %>

                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>

        $(function () { 

                let chatUrl = "<%= typeof data.chatUrl != 'undefined' ? data.chatUrl : '' %>";
                //let socket = io(chatUrl);
                let socket = io();
                let user = {};
                user.user_id = '<%= data.userid %>';
                user.name = '<%= data.name %>';

                socket.on('connect', () => {  
                    <% if (data.type == "U") { %>
                        socket.emit("chat_join", user);
                    <% } %>
                });

                <% if (data.type == "A") { %>

                    let user_list = {};
                    let onlineusers = '<%- JSON.stringify(data.onlineusers) %>';

                    if (typeof onlineusers !== 'undefined' && onlineusers.length > 0){
                        JSON.parse(onlineusers).forEach(function(u){
                            if (!user_list[u.id]) {
                                user_list[u.id] = u.name;
                            }
                        }); 
                    }
                    setLoggedUser(user_list);
                    socket.on('logged_user', (data) => {
                        if (!user_list[data.id]) {
                            user_list[data.id] = data.name;
                        }
                        console.log(user_list);
                        setLoggedUser(user_list);
                    });
                <% } %>
                // socket.on('server msg', (data) => {
                //     console.log(data);
                // });
                // socket.on('s_msg', (data) => {
                //     $("#connection_msg").html(data);
                //     $("#alert").removeClass('invisible');
                //     $("#alert").addClass('visible');
                // });

                $('#send').click(function (e) {
                    alert('hiiii');
                    e.preventDefault();
                    socket.emit('chat message', $('#message').val());
                    $('#message').val('');
                    return false;
                });

            

        });

        let setLoggedUser = (data) => {
            if (typeof data !== 'undefined'){
                for (let key in data){
                    if ($("#"+key).length == 0){
                        let div = '<div class="col-12 pl-0 pr-0 cursor" id="'+key+'">';
                        div += '<div class="col-10 pl-0 pr-0"><span><i class="fa fa-user-circle-o text-success" aria-hidden="true"></i></span> '+data[key]+'</div>';
                        div += '</div>';
                        $("#logged_users").append(div);
                    }
                }
            }
        };
    </script>
 